# Relatório 03

## A estrutura da tabela criada

CREATE TABLE AUDITORIA(
    AUD_ID NUMBER(4),
    EMPLOYEE_ID NUMBER(6, 0),
    AUD_USUARIO VARCHAR2(30),
    AUD_SALARIO_ANTIGO NUMBER(8, 2),
    AUD_SALARIO_NOVO NUMBER(8, 2),
    AUD_DATA_ALTERACAO DATE,
    CONSTRAINT PK_AUDITORIA_AUD_ID PRIMARY KEY (AUD_ID),
    CONSTRAINT FK_AUDITORIA_EMPLOYEE_ID FOREIGN KEY (EMPLOYEE_ID) REFERENCES EMPLOYEES (EMPLOYEE_ID)
);

## O código-fonte do trigger

CREATE OR REPLACE TRIGGER TRG_AUDITORIA BEFORE UPDATE
ON EMPLOYEES
FOR EACH ROW

DECLARE RES_USER VARCHAR2(30);
BEGIN
    SELECT USER INTO RES_USER FROM DUAL;
    
    INTO AUDITORIA (AUD_ID, EMPLOYEE_ID, AUD_USUARIO, AUD_SALARIO_ANTIGO, AUD_SALARIO_NOVO, AUD_DATA_ALTERACAO)
    VALUES (SEQ_AUDITORIA.NEXTVAL, NEW.EMPLOYEE_ID, RES_USER, OLD.SALARY, NEW.SALARY, TO_DATE(SYSDATE));
END TRG_AUDITORIA;

## O select com os dados inseridos pela auditoria

SELECT 
    EMP.FIRST_NAME || ' ' || EMP.LAST_NAME EMPREGADO,
    AUD.AUD_USUARIO USUARIO,
    AUD.AUD_SALARIO_ANTIGO SALARIO_ANTIGO,
    AUD.AUD_SALARIO_NOVO SALARIO_NOVO,
    AUD.AUD_DATA_ALTERACAO DATA_ALTERACAO
FROM
    AUDITORIA AUD
    INNER JOIN
        EMPLOYEES EMP
        ON EMP.EMPLOYEE_ID = AUD.EMPLOYEE_ID;

